CREATE PROCEDURE  [dbo].[STP_InsertCaseandImagesWhileCopying]  
(
	@DomainId NVARCHAR(50),
	@NODETYPE CHAR,  
	@PARENTID INT,  
	@FILEPATH NVARCHAR(255),  
	@IMAGEID INT,  
	@TAGID INT,  
	@LOGINID NVARCHAR(255),  
	@CASEID NVARCHAR(255),  
	@BasePathId INT,
	@NODEID INT OUTPUT    
)
AS    
	DECLARE @NODELEVEL INT  
	DECLARE @NEWIMAGEID INT  
  
	IF @NODETYPE='D'  
	BEGIN   
		 SELECT @NODELEVEL=NODELEVEL+1 FROM TBLTAGS WHERE NODEID=@PARENTID and DomainId=@DomainId
		 INSERT INTO 
			TBLTAGS 
		(
			PARENTID, NODENAME,  CASEID, DOCTYPEID, NODEICON, NODELEVEL, EXPANDED, DomainId
		)  
		SELECT 
			@PARENTID, NODENAME, @CASEID, DOCTYPEID, NODEICON, @NODELEVEL, EXPANDED, @DomainId
		FROM 
			TBLTAGS 
		WHERE 
			NODEID=@TAGID    
		SET @NODEID=@@IDENTITY  
	END  
	ELSE  
	BEGIN  
	  
		INSERT INTO TBLDOCIMAGES 
		(
			FILENAME, FILEPATH, OCRDATA, STATUS, BasePathId, DomainId
		)  
		SELECT 
			FILENAME, @FILEPATH, OCRDATA, STATUS, @BasePathId, @DomainId
		FROM 
			TBLDOCIMAGES 
		WHERE 
			IMAGEID=@IMAGEID-- IN (SELECT IMAGEID FROM TBLIMAGETAG WHERE TAGID=@TAGID)  
			   ---Start of  changes for LSS-470 done on 5 APRIL 2020  By Tushar Chandgude  
     AND IsDeleted = 0  
            ---End   of  changes for LSS-470 done on 5 APRIL 2020  By Tushar Chandgude  
		SET @NEWIMAGEID=@@IDENTITY  

		INSERT INTO TBLIMAGETAG 
		(
			IMAGEID, TAGID, LOGINID, DateInserted, DomainId
		)   
		VALUES 
		(
			@NEWIMAGEID,@PARENTID,@LOGINID, GetDate(), @DomainId
		)
	END

